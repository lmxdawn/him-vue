<template>
    <div>
        <!--é”™è¯¯ä¿¡æ¯æ–¹ä¾¿è°ƒè¯•-->
        <div class="errlog-box" v-if="errLog.length > 0">

            <textarea id="errlog" v-model="errLog">

        </textarea>
        </div>
        <div class="text" :class="{'is-show': isShow}">
            <h1 class="title" style="font-size: 18px;">ä¸€ç¯‡æ–‡ç« å¼•å‘çš„<span style="color: red;">xue</span>æ¡ˆ</h1>
            <div class="content">
                ä¸€æ¬¡è¯»å…¬å·æ¨æ–‡, å‘ç°ä¸€ç¯‡æ–‡ç« å†™å¾—ç‰¹å¥½, å‹¾èµ·äº†å¥½å¥‡å¿ƒ
                <h2 style="margin-top: 20px;"><a target="_blank" href="https://mp.weixin.qq.com/s/so7F88S7-3Wmq9x_rrYAoA">ã€Šç¾¤èŠæ¯”å•èŠï¼Œä¸ºä»€ä¹ˆå¤æ‚è¿™ä¹ˆå¤šï¼Ÿã€‹</a></h2>
                <h5><span style="color: rgb(0, 82, 255)">( ç”»å¤–éŸ³: ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… )</span> </h5>
                <h3 style="margin-top: 10px;">ä»æ­¤æ— æ³•è‡ªæ‹”</h3>
                <div style="color: #99a9bf">äºæ˜¯æœ‰äº†ä¸‹é¢çš„æ•…äº‹</div>
                <h3 style="margin-top: 20px;">å¼€æºçš„H5èŠå¤©ç³»ç»Ÿ </h3>
                <h5><span style="color: rgb(0, 82, 255)">( ç”»å¤–éŸ³: å¼€æºçˆ±å¥½è€…ğŸ˜ )</span> </h5>
                <div style="color: #99a9bf">æ³¨: ä½ ä¼šå‘ç°è¿™ä¸ªç³»ç»Ÿæ˜¯é€‚é…æ‰‹æœºç«¯å’ŒPCç«¯çš„</div>
                <h5 style="margin-top: 20px;"><span>( åœ°å€ )</span> </h5>
                <div style="margin-top: 10px;">
                    <a href="https://github.com/lmxdawn/him-vue" style="margin-left: 2px;"><img src="https://img.shields.io/badge/him-him--vue-1.svg"/></a>
                    <a href="https://github.com/lmxdawn/him-netty" style="margin-left: 2px;"><img src="https://img.shields.io/badge/him-him--netty-1.svg"/></a>
                    <a href="https://shang.qq.com/wpa/qunwpa?idkey=d4965fc7101936dcdea5eb1d05e2eaeb3128f20796028ee937ab516652083c6c" style="margin-left: 2px;"><img src="https://img.shields.io/badge/QQ%E7%BE%A4-210277856-orange.svg"/></a>
                </div>

                <h3 style="color: red;margin-top: 10px;">ç‚¹å‡»å³ä¸‹è§’ ï¹¤æˆ‘ä»¬å¼€å§‹èŠå¤©å§~ï¹¥ æŒ‰é’®</h3>

                <h3 style="margin-top: 20px;">æ“ä½œæµç¨‹</h3>
                <h4 style="color: green">
                    <br/>
                    ç‚¹å‡»å³ä¸‹æ–¹çš„æˆ‘ä»¬èŠå¤©å§
                    <br/>
                    <span style="font-size: 20px;">â†“</span>
                    <br/>
                    å¥³æ¸¸å®¢/ç”·æ¸¸å®¢/QQç™»å½•
                    <br/>
                    <span style="font-size: 20px;">â†“</span>
                    <br/>
                    ç‚¹å‡»å³ä¸Šæ–¹çš„ äºŒç»´ç æŒ‰é’®, ç”ŸæˆäºŒç»´ç  <span style="color: red;">æ³¨æ„: å»ºè®®åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•, å› ä¸ºåå¤æµ‹è¯•, åœ¨iOSæ‰‹æœºç‰ˆçš„QQä¸­é€€å‡ºç™»å½•ä¼šå¤±è´¥, å› ä¸ºCookieæ¸…ç©ºä¸äº†</span>
                    <br/>
                    <span style="font-size: 20px;">â†“</span>
                    <br/>
                    æŠŠç”Ÿæˆå¥½çš„äºŒç»´ç å‘ç»™å¥½å‹
                    <br/>
                    <span style="font-size: 20px;">â†“</span>
                    <br/>
                    è¿™ä¸ªæ—¶å€™ç­‰å¾…å¥½å‹ç¡®è®¤, å°±å¯ä»¥èŠå¤©äº†
                    <br/>
                    <span style="font-size: 20px;">â†“</span>
                    <br/>
                    å·¦ä¸‹è§’ æ¢è‚¤å›¾æ ‡ å¯ä»¥åˆ‡æ¢çš®è‚¤

                </h4>

                <h1>åŠŸèƒ½åˆ—è¡¨</h1>
                <div class="gongneng-list">
                    <div><label><input type="checkbox" disabled checked />å•èŠ</label></div>
                    <div><label><input type="checkbox" disabled checked />ç¾¤èŠ</label></div>
                    <div><label><input type="checkbox" disabled checked />protobuf ç¼–è§£ç </label></div>
                    <div><label><input type="checkbox" disabled checked />å®¢æˆ·ç«¯å¿ƒè·³</label></div>
                    <div><label><input type="checkbox" disabled checked />å®¢æˆ·ç«¯æ–­å¼€é‡è¿</label></div>
                    <div><label><input type="checkbox" disabled checked />å¼‚åœ°ç™»å½•, é€šçŸ¥ä¸‹çº¿</label></div>
                    <div><label><input type="checkbox" disabled checked />ç§»åŠ¨ç«¯/PCç«¯é€‚é…</label></div>
                    <div><label><input type="checkbox" disabled checked />ç¦»çº¿æ¶ˆæ¯ (ack æœºåˆ¶, å®ç°å¯è¾¾æ€§)</label></div>
                    <div><label><input type="checkbox" disabled checked />ç¬¬ä¸‰æ–¹QQç™»å½•</label></div>
                    <div><label><input type="checkbox" disabled checked />è‡ªå¸¦ emoji è¡¨æƒ…</label></div>
                    <div><label><input type="checkbox" disabled checked />æ–‡æœ¬æ¶ˆæ¯</label></div>
                    <div><label><input type="checkbox" disabled/>å£°éŸ³æç¤º</label></div>
                    <div><label><input type="checkbox" disabled/>å›¾ç‰‡æ¶ˆæ¯</label></div>
                    <div><label><input type="checkbox" disabled/>éŸ³é¢‘æ¶ˆæ¯</label></div>
                    <div><label><input type="checkbox" disabled/>è§†å±æ¶ˆæ¯</label></div>
                    <div><label><input type="checkbox" disabled/>åˆ†å¸ƒå¼éƒ¨ç½²</label></div>
                    <div><label><input type="checkbox" disabled/>PHP ç‰ˆæœ¬çš„ (Workerman ç‰ˆæœ¬)</label></div>
                </div>

            </div>

            <h2 style="margin-top: 20px;">æ•ˆæœå›¾</h2>

            <div class="img-list">

                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG6.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG6.jpeg'/>
                </div>

                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG7.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG7.jpeg'/>
                </div>


                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG8.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG8.jpeg'/>
                </div>


                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG9.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG9.jpeg'/>
                </div>


                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG10.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG10.jpeg'/>
                </div>


                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG11.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG11.jpeg'/>
                </div>


                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG12.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG12.jpeg'/>
                </div>


                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG13.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG13.jpeg'/>
                </div>


                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG14.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG14.jpeg'/>
                </div>


                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG15.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG15.jpeg'/>
                </div>


                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG16.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG16.jpeg'/>
                </div>


                <div class="img-list-item">
                    <!--<img src='https://github.com/lmxdawn/him-vue/raw/master/pic/WechatIMG17.jpeg'/>-->
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG17.jpeg'/>
                </div>


                <div class="img-list-item">
                    <img src='http://prbsvykmy.bkt.clouddn.com/pic/WechatIMG18.jpeg'/>
                </div>

            </div>

        </div>

        <div class="view-box">
            <him ref="him"
                :isShow="isShow"
                width="350px"
                height="650px"
                bottom="0"
                right="0"
                :apiBaseUrl="apiBaseUrl"
                :webSocketUrl="webSocketUrl"
                :userQRCodeUrl="userQRCodeUrl"
                :groupQRCodeUrl="groupQRCodeUrl"
                :WSResEncode="WSResEncode"
                :WSResDecode="WSResDecode"
                @on-is-show-click="isShowClick"
                @on-qq-login-click="qqLoginClick"
                @on-login-init="loginInit"
                @on-request-err="requestErr">

            </him>
        </div>
        <div class="btn-ok" @click="isShowClick" v-if="!isShow">
            <i class="icon"></i>
            <span class="text">æˆ‘ä»¬èŠå¤©å§~</span>
        </div>
    </div>
</template>

<script>
import Cookies from "js-cookie";
// protobuf ç¼–ç 
import protoRoot from "@/proto/proto";
import Him from "../components/Him/index";

const WSBaseReqProto = protoRoot.lookup("protocol.WSBaseReqProto");
const WSBaseResProto = protoRoot.lookup("protocol.WSBaseResProto");

export default {
    name: "home",

    data() {
        const qqRedirectUri = "http://him-netty.await.fun/h5";
        return {
            errLog: "",
            isShow: false,
            qqRedirectUri: qqRedirectUri,
            qqLoginUrl:
                "https://graph.qq.com/oauth2.0/authorize?response_type=code&client_id=101579192&redirect_uri=" +
                encodeURIComponent(qqRedirectUri) +
                "&state=1",
            userCheckCode: null,
            groupCheckCode: null,
            apiBaseUrl: process.env.VUE_APP_API_BASE,
            webSocketUrl: process.env.VUE_APP_WEBSOCKET_URL,
            userQRCodeUrl: process.env.VUE_APP_USER_QR_CODE_URL,
            groupQRCodeUrl: process.env.VUE_APP_GROUP_QR_CODE_URL
        };
    },
    components: {
        Him
    },
    methods: {
        // WebSocket ç¼–ç 
        WSResEncode(payload) {
            let errMsg = WSBaseReqProto.verify(payload);
            console.log("buff è§£æé”™è¯¯ä¿¡æ¯ï¼š", errMsg);
            // Create a new message
            const wsData = WSBaseReqProto.create(payload);
            // Encode a message to an Uint8Array (browser) or Buffer (node)
            return WSBaseReqProto.encode(wsData).finish();
        },
        // WebSocket ç¼–ç 
        WSResDecode(data, cb) {
            let reader = new FileReader();
            reader.readAsArrayBuffer(data);
            reader.onload = () => {
                const buf = new Uint8Array(reader.result);
                const response = WSBaseResProto.decode(buf);
                cb(response);
            };
        },
        // ç‚¹å‡»äº†QQç™»å½•
        qqLoginClick() {
            // å‰å»æˆæƒ
            window.location.href = this.qqLoginUrl;
        },
        isShowClick() {
            this.isShow = !this.isShow;
        },
        // ç™»å½•åˆå§‹åŒ–å®Œæˆ
        loginInit() {
            let userCheckCode = this.getUserCheckCode();
            let groupCheckCode = this.getGroupCheckCode();
            console.log("ç™»å½•åˆå§‹åŒ–å®Œæˆ", userCheckCode, groupCheckCode);
            // å¦‚æœæœ‰åŠ æœ‹å‹çš„éªŒè¯ç 
            if (userCheckCode) {
                // å‘é€åŠ å¥½å‹çš„è¯·æ±‚
                this.$refs["him"].createUserFriendAsk(userCheckCode);
                // å‘é€ååˆ é™¤
                this.delUserCheckCode();
                this.$router.push("/");
            }
            // å¦‚æœæœ‰åŠ ç¾¤çš„éªŒè¯ç 
            if (groupCheckCode) {
                this.$refs["him"].joinGroupUser(groupCheckCode);
                // å‘é€ååˆ é™¤
                this.delGroupCheckCode();
                this.$router.push("/");
            }
            // ç™»å½•æˆåŠŸ, å»¶æ—¶æ˜¾ç¤ºèŠå¤©ç•Œé¢
            setTimeout(() => {
                this.isShow = true;
            }, 1000);
        },
        requestErr(code, message) {
            let text = "æ¥å£æŠ¥é”™: code: " + code + ", message:" + message;
            this.errLog = text + "\n" + this.errLog;
        },
        getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] === variable) {
                    return pair[1];
                }
            }
            return false;
        },
        setUserCheckCode(value) {
            Cookies.set("USER_CHECK_CODE", value, {
                expires: 1,
                path: "/"
            });
        },
        getUserCheckCode() {
            return Cookies.get("USER_CHECK_CODE", {
                path: "/"
            });
        },
        delUserCheckCode() {
            return Cookies.remove("USER_CHECK_CODE", {
                path: "/"
            });
        },
        setGroupCheckCode(value) {
            Cookies.set("GROUP_CHECK_CODE", value, {
                expires: 1,
                path: "/"
            });
        },
        getGroupCheckCode() {
            return Cookies.get("GROUP_CHECK_CODE", {
                path: "/"
            });
        },
        delGroupCheckCode() {
            return Cookies.remove("GROUP_CHECK_CODE", {
                path: "/"
            });
        }
    },
    mounted() {
        // æˆæƒæˆåŠŸåçš„è·³è½¬
        this.code = this.getQueryVariable("code"); // QQ ç™»å½•çš„codeç 
        if (this.code) {
            this.$refs["him"].qqLogin(this.code, this.qqRedirectUri);
            // æ¸…ç©ºæµè§ˆå™¨åœ°å€æ çš„å€¼, è¿™é‡Œå…¶å®æ˜¯åˆ·æ–°å½“å‰é¡µé¢
            this.$router.push("/");
        }
        // Cookies.remove("UID");
        // Cookies.remove("SID");
    },
    created() {
        // è·å–getå‚æ•°
        let userCheckCode = this.getQueryVariable("userCheckCode");
        // åˆ¤æ–­æ˜¯å¦å’Œ Cookie é‡Œé¢çš„å€¼ç›¸åŒ
        if (
            userCheckCode &&
            userCheckCode !== "" &&
            userCheckCode !== this.getUserCheckCode()
        ) {
            this.setUserCheckCode(userCheckCode);
        }
        let groupCheckCode = this.getQueryVariable("groupCheckCode");
        // åˆ¤æ–­æ˜¯å¦å’Œ Cookie é‡Œé¢çš„å€¼ç›¸åŒ
        if (
            groupCheckCode &&
            groupCheckCode !== "" &&
            groupCheckCode !== this.getGroupCheckCode()
        ) {
            this.setGroupCheckCode(groupCheckCode);
        }
    }
};
</script>

<style type="text/scss" lang="scss">
.btn-ok {
    position: fixed;
    right: 30px;
    bottom: 30px;
    width: auto;
    padding: 20px 30px;
    cursor: pointer;
    border-radius: 33px;
    background-color: #6ed0ce;
    color: #ffffff;
    box-shadow: 7px 7px 12px 4px rgba(2, 25, 25, 0.05);
    text-align: center;
    .icon {
        vertical-align: middle;
        width: 20px;
        height: 20px;
        display: inline-block;
        margin-right: 10px;
        background-size: 100%;
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAhCAYAAAC4JqlRAAAAAXNSR0IArs4c6QAAA51JREFUWAm1l39ojVEYx3e3NWPMZsMWoazsnyn/KC1MSf6Z/GFpIhGapESRaBLlR0Ki/Ig0tVAo2/IjpOYPIo0ls1mT+TVpzNbMjzaf73bOOnbv3vveu+upz32e85znec553/ec8743EBeh9PT0JJOSB1mQAW3QArWBQKAdHXth0AQohhvQCaHkN85qWA/DYzYLii2CBnDlD42PUAvN8Atc+Uxj3ZAmQYEkOOlU7cI+AwvhnyuknQhz4BC0gZUqjLSIJ0KSBq+0VdAXYcLAQvjiQ/jS8B+BbpA8hcyBcZ5tEi4rE9GtXmuDsQvgBDwDe6Ud2HVwFvS4EhSP1p1Sn+QxJNk6nprANcpAdAUrTDENrEH9SBNBS0zeXGy7aI95DmwSMkloB8lh49vR14z4V+slHkpMpi5ohuckCNhjghvRybDXtKNVF0jUAr1nClQNOgET2GoCNeudxh6qKqPAPKfI5JCTIGC2CdIzywVtu1hJEYVemWJbgiZAxxgoNwG3HNu4fCtNviZEtB6pdo9EO0Pnw7TeiWBkwzuwUo9h97D1+dWa/CSwW9TNU11XXtNI0H4tdb1DtJfqqqix3WedXJ1kQSdc762J/Oc4b8NLJu0o+ouPEilBR6mPJDeki8YdKGDwjbYD+wd2mW176USvzgF9nbRfwHOogUfSDPYbHUrKcW4O1eH6/ExAt3I1VDFYt5scxtZEf8Iwrzg/j6CIgSsiHDzO3Jk6r8Hp69YEWjyCmih036M/XNc3jwCtk0ZN4Dx8ByvN1kD7WclOeJCpdWOlFKPJNDrQxVxc37js2Smgt94GGAUPQPLWZkejyX/YW6Xvs00vpRTQEb/Lsx4B88FKumewRycFPpkiqxSGXWjaszzS+roIPG2Cl7vB+LIg4Ppk40uFqdaPnQ+SSsen17K+nvoXf1AhJ3gEdjVo683kefWoj+QclI7cetAi0/+EbNDgB4hrRSvuKkqn7AJ8ejcsxr4GK2mXocMLSenwBLSA+oV2HuyDU4Zt6P4jHXsT3ITRSkLnwFe4DYNedP8ArkFCMhyEEtcvG18GjHT9tPV2dT9kp9N+D29gvBv7X20G0+f5ftA3gp77xJgNSLGxoM9w3dJlbmHa42Ar2M87xaW6MUO2KXgFrOjjRf+IzoHWi9qiAvLDDRbZgjDVKNyAqd1gRS+dRngJd6GSle6eqLhiKExgN1jRH1Ftw6gkqjugkRi0EKWtd52r/SBfNPIXcYb3XT9WZh4AAAAASUVORK5CYII=");
    }
    .text {
        vertical-align: middle;
        line-height: 20px;
    }
}
.view-box {
    width: 100%;
}
.text {
    margin-top: 10px;
    text-align: center;
    .content {
        /*text-align: left;*/
        margin-top: 20px;
    }
}
.img-list {
    padding-left: 80px;
    padding-right: 80px;
    text-align: left;
    .img-list-item {
        display: inline-block;
        padding: 20px;
        width: 50%;
        vertical-align: top;
        img {
            width: 100%;
        }
    }
}
.gongneng-list {
    width: 300px;
    margin: 0 auto;
    text-align: left;
    input {
        -webkit-appearance: checkbox;
        -moz-appearance: checkbox;
        appearance: checkbox;
        margin-right: 5px;
    }
}
.errlog-box {
    width: 400px;
    margin: 0 auto;
    height: 300px;
    color: red;
    textarea {
        width: 100%;
        height: 100%;
    }
}
@media screen and (max-width: 768px) {
    .errlog-box {
        width: 100%;
    }
    .gongneng-list {
        width: 80%;
    }
    .img-list {
        padding-left: 0;
        padding-right: 0;
        .img-list-item {
            width: 100%;
        }
    }
    /*æ‰‹æœºç«¯éšè—èƒŒå*/
    .is-show {
        display: none;
    }
}
</style>
